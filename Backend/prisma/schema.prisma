// Prisma Schema for AI Outreach Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Recruiter Model
model Recruiter {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  company       String?
  jobTitle      String?
  linkedIn      String?
  country       String?
  field         String?   // e.g., "Technology", "Finance", "Healthcare"
  platform      String?   // e.g., "CSV Upload", "Manual Entry"
  status        String    @default("active") // active, inactive, bounced
  enrichedData  Json?     // Additional AI-enriched data

  // Google Calendar Integration
  googleRefreshToken String?
  googleAccessToken  String?
  googleTokenExpiry  DateTime?
  googleCalendarId   String?   @default("primary")
  
  // Relations
  campaigns     CampaignRecipient[]
  meetings      Meeting[] @relation("RecruiterMeetings")
  availabilitySlots AvailabilitySlot[] @relation("RecruiterAvailability")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([country, field])
  @@index([status])
}

// Student Model
model Student {
  id                String    @id @default(uuid())
  name              String
  email             String    @unique
  phone             String?
  university        String?
  major             String?
  graduationYear    Int?
  country           String?
  degree            String?   // e.g., "B.Tech", "M.Tech", "BCA"
  platform          String?   // e.g., "GitHub", "University Directory"
  linkedIn          String?
  resume            String?   // URL or path to resume
  status            String    @default("waitlist") // waitlist, contacted, scheduled, completed
  waitlistJoinedAt  DateTime  @default(now())
  enrichedData      Json?     // Additional data including CSV import data
  
  // Relations
  campaigns         CampaignRecipient[]
  meetings          Meeting[] @relation("StudentMeetings")
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([email])
  @@index([status])
  @@index([country])
}

// Email Campaign Model
model Campaign {
  id              String    @id @default(uuid())
  name            String
  targetAudience  String    // "recruiters", "students", "both"
  subject         String
  template        String    @db.Text
  status          String    @default("draft") // draft, scheduled, sending, completed, paused
  scheduledAt     DateTime?
  completedAt     DateTime?
  
  // Analytics
  totalRecipients Int       @default(0)
  sentCount       Int       @default(0)
  deliveredCount  Int       @default(0)
  openedCount     Int       @default(0)
  clickedCount    Int       @default(0)
  bouncedCount    Int       @default(0)
  
  // Relations
  recipients      CampaignRecipient[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([status])
  @@index([scheduledAt])
}

// Campaign Recipients (many-to-many with tracking)
model CampaignRecipient {
  id            String    @id @default(uuid())
  campaignId    String
  recipientType String    // "recruiter" or "student"
  recruiterId   String?
  studentId     String?
  
  // Email tracking
  personalizedContent String? @db.Text
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  bouncedAt     DateTime?
  status        String    @default("pending") // pending, sent, delivered, opened, clicked, bounced, failed
  
  // Relations
  campaign      Campaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  recruiter     Recruiter? @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  student       Student?   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  @@index([campaignId])
  @@index([status])
  @@index([recruiterId])
  @@index([studentId])
}

// Recruiter Availability Slots (marked by recruiter, confirmed by admin)
model AvailabilitySlot {
  id            String    @id @default(uuid())
  recruiterId   String
  
  startTime     DateTime
  endTime       DateTime
  duration      Int       // in minutes
  timezone      String    @default("America/New_York")
  
  // Status tracking
  status        String    @default("pending") // pending, confirmed, cancelled
  confirmedBy   String?   // Admin ID who confirmed
  
  // Related meeting (once admin assigns student)
  meetingId     String?   @unique
  meeting       Meeting?  @relation("AvailabilityMeeting", fields: [meetingId], references: [id])
  
  // Relations
  recruiter     Recruiter @relation("RecruiterAvailability", fields: [recruiterId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([recruiterId])
  @@index([startTime])
  @@index([status])
}

// Meeting Model
model Meeting {
  id                String    @id @default(uuid())
  recruiterId       String
  studentId         String
  
  title             String
  description       String?   @db.Text
  eventField        String?   // e.g., "Technology", "Finance", "Healthcare"
  keyAreas          String[]  @default([]) // Key topics/areas to discuss
  scheduledTime     DateTime
  duration          Int       @default(30) // in minutes
  timezone          String    @default("America/New_York")
  
  // Google Calendar
  googleMeetLink    String?
  calendarEventId   String?   @unique
  
  // Status tracking
  status            String    @default("scheduled") // scheduled, confirmed, completed, cancelled, no-show
  confirmationSent  Boolean   @default(false)
  reminderSent      Boolean   @default(false)
  
  // Relations
  recruiter         Recruiter @relation("RecruiterMeetings", fields: [recruiterId], references: [id], onDelete: Cascade)
  student           Student   @relation("StudentMeetings", fields: [studentId], references: [id], onDelete: Cascade)
  availabilitySlot  AvailabilitySlot? @relation("AvailabilityMeeting")
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([recruiterId])
  @@index([studentId])
  @@index([scheduledTime])
  @@index([status])
}

// CSV Upload Model
model CsvUpload {
  id            String    @id @default(uuid())
  
  // File information
  filename      String    // Generated unique filename
  originalName  String    // Original filename from user
  fileSize      Int       // Size in bytes
  filePath      String    // Path to stored file
  
  // Upload metadata
  recordType    String    // "recruiter" or "student"
  uploadedBy    String?   // Admin ID (if auth implemented)
  
  // Processing status
  status        String    @default("pending") // pending, processing, completed, failed
  totalRecords  Int       @default(0)
  successCount  Int       @default(0)
  errorCount    Int       @default(0)
  
  // Timestamps
  uploadedAt    DateTime  @default(now())
  processedAt   DateTime?
  
  // Additional metadata
  metadata      Json?     // Column mappings, validation rules, etc.
  
  // Relations
  errors        CsvUploadError[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([recordType])
  @@index([status])
  @@index([uploadedAt])
}

// CSV Upload Error Model
model CsvUploadError {
  id            String    @id @default(uuid())
  csvUploadId   String
  
  rowNumber     Int
  errorMessage  String    @db.Text
  rowData       Json?     // The problematic row data
  fieldName     String?   // Specific field that caused error
  
  // Relations
  csvUpload     CsvUpload @relation(fields: [csvUploadId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  
  @@index([csvUploadId])
}

// Admin User Model (for dashboard access)
model Admin {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          String    @default("admin") // admin, super_admin
  isActive      Boolean   @default(true)
  
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
}

// Email Template Model (for reusable email templates)
model EmailTemplate {
  id          String   @id @default(uuid())
  name        String   // "Recruiter Outreach", "Student Welcome", etc.
  category    String   // "recruiter", "student", "both"
  subject     String
  content     String   @db.Text // Handlebars template with placeholders
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([isActive])
}

// Document Model (for PDF/text documents uploaded for RAG context)
model Document {
  id          String   @id @default(uuid())
  fileName    String   // Original filename
  fileSize    Int      // Size in bytes
  category    String   @default("general") // "app_info", "company_info", "product_details", "general", etc.
  uploadedBy  String?  // Admin ID who uploaded (if auth implemented)
  uploadDate  DateTime @default(now())
  status      String   @default("processing") // "processing", "ready", "failed"
  chunkCount  Int      @default(0) // Number of text chunks created
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([status])
  @@index([uploadDate])
  @@map("documents")
}
